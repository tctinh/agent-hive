# Hive Data Model

## Structure

```
.hive/
├── config.json
├── journal.md
└── features/
    └── {feature-name}/
        ├── status.json          # Feature state (planning/approved/executing/completed)
        ├── plan.md              # Execution plan
        ├── comments.json        # Plan review comments
        ├── sessions.json        # Session tracking
        ├── context/             # Persistent knowledge files
        │   ├── decisions.md
        │   ├── architecture.md
        │   └── constraints.md
        └── tasks/               # Individual task folders (PRIMARY)
            └── {NN-task-name}/
                ├── status.json  # Task state + metadata
                ├── spec.md      # Task context and requirements
                ├── worker-prompt.md # Full worker prompt (generated)
                └── report.md    # Execution summary and results

.hive/.worktrees/              # Isolated git worktrees
    └── {feature}/{task}/      # Full repo copy for safe execution
```

## Prompt Files

`worker-prompt.md` is generated by `hive_exec_start` and contains the full worker prompt.
Delegated execution passes this file path via `workerPromptPath`/`promptFile` to avoid tool output truncation.

## Task status.json

```json
{
  "status": "done",
  "origin": "plan",
  "planTitle": "Implement login",
  "summary": "Login endpoint implemented with JWT",
  "startedAt": "2025-01-05T09:00:00Z",
  "completedAt": "2025-01-05T10:30:00Z",
  "baseCommit": "abc123",
  "dependsOn": ["01-setup", "02-database-schema"]
}
```

### Fields

| Field | Type | Description |
|-------|------|-------------|
| `status` | string | Task status (see Status Values below) |
| `origin` | string | `"plan"` (from plan.md) or `"manual"` (manually created) |
| `planTitle` | string? | Task title from plan.md |
| `summary` | string? | Execution summary |
| `startedAt` | string? | ISO timestamp when task started |
| `completedAt` | string? | ISO timestamp when task completed |
| `baseCommit` | string? | Git commit hash at task start |
| `dependsOn` | string[]? | Task folder names this task depends on (e.g., `["01-setup"]`). A task cannot start until all dependencies have status `done`. Resolved from plan.md `Depends on:` annotations during `hive_tasks_sync`. |

**Dependency rules**:
- Only status `done` satisfies a dependency.
- If `dependsOn` is omitted (legacy/manual tasks), Hive applies implicit sequential ordering based on the numeric task prefix (N depends on N-1).

## Status Values

Task statuses (TaskStatusType):
- `pending`: Not started
- `in_progress`: Currently being worked on
- `done`: Completed successfully
- `blocked`: Waiting for user decision
- `failed`: Execution failed (errors, tests not passing)
- `partial`: Partially completed (some work done, not finished)
- `cancelled`: Cancelled by user

Feature statuses (FeatureStatusType):
- `planning`: Plan being written/reviewed
- `approved`: Plan approved, ready for execution
- `executing`: Tasks being executed
- `completed`: All tasks done, feature complete

## hive_status Output

`hive_status` returns a JSON summary of feature state and task readiness.

### Task List Fields

Each entry in `tasks.list` includes:
- `folder` (string)
- `name` (string)
- `status` (string)
- `origin` (string)
- `summary` (string | null)
- `dependsOn` (string[] | null)

### Runnable and Blocked

```
tasks.runnable   # array of task folders ready to start
tasks.blockedBy  # map: task folder -> array of unmet dependency folders
```

Rules:
- Only `done` satisfies dependencies.
- If `dependsOn` is omitted (legacy/manual tasks), runnable/blocked uses implicit sequential ordering (N depends on N-1).

Example:

```json
{
  "tasks": {
    "list": [
      {"folder":"01-setup","status":"done","dependsOn":[]},
      {"folder":"02-core","status":"pending","dependsOn":["01-setup"]},
      {"folder":"03-ui","status":"pending","dependsOn":[]}
    ],
    "runnable": ["02-core","03-ui"],
    "blockedBy": {}
  }
}
```

## spec.md Structure

`spec.md` is generated for each task. It always includes a **Dependencies** section:

```
## Dependencies
- **1. Setup** (01-setup)
```

If a task has no dependencies (explicit `Depends on: none`), the section is:

```
## Dependencies
_None_
```

## Session Metadata

Sessions are tracked per feature in `sessions.json`:

```json
{
  "master": "ses_abc123",
  "sessions": [
    {
      "sessionId": "ses_abc123",
      "taskFolder": "01-first-task",
      "startedAt": "2025-01-05T09:00:00Z",
      "lastActiveAt": "2025-01-05T10:30:00Z",
      "messageCount": 42
    }
  ]
}
```

## Migration from Legacy

Previous versions used `execution/` directory with step-based JSON files.
Current version uses `tasks/` with folder-per-task structure containing
`status.json`, `spec.md`, and `report.md`.
